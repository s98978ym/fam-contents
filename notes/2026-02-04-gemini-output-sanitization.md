# Gemini出力のサニタイズとプロンプト改善

## 何をしたか

- Gemini APIの診断機能を追加（`/api/health` エンドポイント、`fallback_reason` フィールド）
- AIナレッジ発展プロンプトのフォーマットルール・文体ルールを大幅強化
- サーバー側に `stripMarkdown()` セーフティネットを追加

## ハマったポイント

### 1. Geminiはプロンプトの禁止事項を無視することがある

「Markdown記号を使うな」と指示しても `**太字**` を出力した。
「見出し語: 説明文の形式を使うな」と指示しても `**選手の個性を見つける**: ...` を出力した。

原因: 禁止指示が抽象的すぎた。Geminiは「Markdownを除去し、プレーンテキストにする」のような曖昧な指示ではMarkdownを除去しない。

対策:
- ○×の具体例を複数示す（正しい例と間違った例を並べる）
- サーバー側で強制除去する `stripMarkdown()` を二重対策として入れる

### 2. AI特有の文体は明示的に禁止しないと出る

「共感と感情的な繋がり:」「多角的なアプローチ」のようなAI的表現がデフォルトで出力される。
「自然な文体で」だけでは不十分。

対策: 具体的なNG例を列挙し、代わりに「先輩が口頭で教えるような文体」とロールを指定した。

### 3. 環境変数のスコープ問題

VercelのPreviewデプロイでは、Production スコープのみの環境変数は読めない。
`/api/health` エンドポイントと `fallback_reason` で原因特定が容易になった。

## 次回の注意点

- Geminiプロンプトでフォーマットを制御する場合、プロンプト指示だけに頼らず、コード側でも後処理を入れる
- 禁止事項は抽象的に書かず、必ず具体的なNG例を○×で示す
- 新しいAI出力を追加するときは、`stripMarkdown()` を通しているか確認する
