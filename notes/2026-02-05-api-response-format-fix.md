# APIレスポンス形式不整合の修正

## 日付
2026-02-05

## 概要
Vercel本番環境で `e.map is not a function` エラーが発生。エラーバウンダリーを追加してエラー詳細を取得し、根本原因を特定・修正した。

## 問題の経緯

1. Google Drive連携に `source` フィールドを追加（外部API連携ルールに従って）
2. `/api/drive/folders` のレスポンス形式が変更:
   - 変更前（推定）: `[{ id, name, ... }, ...]`（配列直接）
   - 変更後: `{ folders: [...], source: "mock", message: "..." }`（オブジェクト）
3. クライアント側のコードは配列を期待したまま `.map()` を呼び出し
4. Vercelで「Application error: a client-side exception has occurred」という汎用エラーが表示され、詳細不明

## エラーの特定方法

1. `error.tsx`（ページレベル）と `global-error.tsx`（レイアウトレベル）のエラーバウンダリーを追加
2. 再デプロイ後、エラーメッセージ `e.map is not a function` が表示された
3. `Grep` で `.map(` を検索し、APIレスポンスを配列として扱っている箇所を特定

## 修正内容

### 修正ファイル

| ファイル | 修正前 | 修正後 |
|---------|--------|--------|
| `src/app/contents/page.tsx:23` | `setFolders(data)` | `setFolders(data.folders \|\| [])` |
| `src/app/knowledge/page.tsx:623` | `setFolders(Array.isArray(data) ? data : [])` | `setFolders(data.folders \|\| [])` |
| `src/app/contents/[id]/page.tsx:257-261` | `folders`, `files` を直接使用 | `foldersData.folders`, `filesData.files` を抽出 |

### 追加ファイル

- `src/app/error.tsx` - ページレベルのエラーバウンダリー
- `src/app/global-error.tsx` - レイアウトレベルのエラーバウンダリー

## ハマったポイント

1. **汎用エラーメッセージでは原因特定不可**: Vercelのデフォルトエラー画面は「Application error」としか表示されず、実際のエラー内容がわからなかった

2. **error.tsx だけでは不十分**: レイアウト（`layout.tsx`）内でエラーが発生した場合、`error.tsx` ではキャッチできない。`global-error.tsx` が必要

3. **APIレスポンス変更の影響範囲**: 一つのAPIルートのレスポンス形式を変更すると、複数のページに影響する可能性がある。`Grep` で呼び出し元を全て検索する必要があった

## 根本原因の分析

### 表面的な原因
- クライアントコードが配列を期待していたが、APIはオブジェクトを返した

### 直接的な原因
- `source` フィールド追加のためにAPIレスポンスをオブジェクトでラップしたが、クライアント側の更新が漏れた

### 構造的な原因
- API変更とクライアント変更が同一コミットで行われなかった
- APIレスポンスの型定義がクライアント側で共有されていなかった
- 「外部API連携ルール」で `source` 追加を義務付けたが、それに伴うレスポンス形式変更の影響範囲確認が明文化されていなかった

## CLAUDE.mdへの追記

### よくあるミスと対策（新規追加）

| ミス | 原因 | 対策 |
|------|------|------|
| APIレスポンス形式変更時にクライアント側が未更新で `e.map is not a function` | `source` フィールドを追加するためにAPIレスポンスを配列からオブジェクトに変更したが、クライアント側のコードは配列を期待したまま | **APIレスポンス形式を変更する際のチェックリスト**: (1) 全ての呼び出し元を検索 (2) クライアント側を同時に修正 (3) 配列→オブジェクトラッピング時の定型パターンを使用 (4) TypeScript型定義を活用 |

### 外部API連携ルール（新規追加）

「APIレスポンス形式の統一（必須）」セクションを追加:
- 配列を返すAPIは必ずオブジェクトでラップする
- レスポンス形式を変更したら全クライアントを同時更新
- 既存APIのレスポンス形式一覧を記載

## 次回の注意点

1. **APIレスポンス変更時は必ずGrepで呼び出し元を検索**
   ```
   Grep: pattern="/api/drive/folders"
   ```

2. **API変更とクライアント変更は同一コミットで**
   - 別々のコミットにすると、一時的に不整合状態が生じる

3. **エラーバウンダリーは最初から入れておく**
   - 本番環境でのデバッグが格段に楽になる

4. **TypeScript型を活用**
   - APIレスポンス型を定義し、クライアント側でも参照することで、型チェックで不整合を検出
