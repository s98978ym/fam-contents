# Gemini/シミュレーション判別表示の追加

## 何をしたか

- APIレスポンスに `source: "gemini" | "simulation"` フィールドを追加 (`route.ts`)
- UIにフォールバック判別表示を追加 (`knowledge/page.tsx`)
  - シミュレーション時: amber警告バナー「Gemini API未接続のためシミュレーションモードです」
  - Gemini接続時: 緑の「Gemini」バッジを「AIが発展」ラベル横に表示
- QuickPostBox, NewPostForm の両方に `proofreadSource` stateを追加
- サーバーログに `[proofread]` プレフィックスで接続状態を出力
- CLAUDE.mdにフォールバック透明性ルールを追記
- CLAUDE.mdにデプロイ環境（Vercel）を明記
- 警告バナーのテキストを環境非依存に修正（`.env.local` → 「環境変数を設定し、再デプロイ」）

## ハマったポイント

### 1. フォールバックがサイレントに動作
- フォールバックがサイレントに動作していたため、ユーザーが「AIが壊れている」と認識した
- UIの出力だけでは、Geminiの結果なのかシミュレーションの結果なのか判別できなかった
- フォールバックのシミュレーションが `**` 除去程度しかせず、元の文章とほぼ同じ結果を返していた

### 2. デプロイ環境を確認せずローカル前提で案内
- Vercel環境のユーザーに `.env.local` とサーバー再起動を案内してしまった
- 実際はVercelダッシュボードで環境変数を設定し、再デプロイが必要
- 警告バナーのテキストも `.env.local` を直接参照しており、環境依存だった
- 教訓: UIメッセージやドキュメントは特定環境に依存しない表現にする

## 次回の注意点

- **サイレントフォールバックは禁止**: 外部API呼び出しがある機能では、レスポンスに必ず `source` フィールドを含め、UIで明示する
- **デプロイ環境を前提にしない**: 環境変数の設定方法はVercel/ローカルで異なる。UIメッセージは環境非依存にする
- Vercelでは環境変数追加後に再デプロイが必要
- 新しいAPI連携機能を追加する際は、最初から判別表示を組み込む
